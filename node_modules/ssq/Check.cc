#include <node.h>
#include "Check.h"

using namespace v8;

Persistent<Function> Check::constructor;

Check::Check()
{
    this->redBallLength = 6;
    this->redBall = new int[this->redBallLength];
}

Check::~Check()
{
    delete[] this->redBall;
}

void Check::Init()
{
    Local<FunctionTemplate> tpl = FunctionTemplate::New(New);
    tpl->SetClassName(String::NewSymbol("Check"));
    tpl->InstanceTemplate()->SetInternalFieldCount(1);
    tpl->PrototypeTemplate()->Set(String::NewSymbol("setBlueBall"), FunctionTemplate::New(SetBlueBall)->GetFunction());
    tpl->PrototypeTemplate()->Set(String::NewSymbol("setRedBall"), FunctionTemplate::New(SetRedBall)->GetFunction());
    tpl->PrototypeTemplate()->Set(String::NewSymbol("setGl"), FunctionTemplate::New(SetGl)->GetFunction());
    tpl->PrototypeTemplate()->Set(String::NewSymbol("count"), FunctionTemplate::New(Count)->GetFunction());
    tpl->PrototypeTemplate()->Set(String::NewSymbol("count0000"), FunctionTemplate::New(Count0000)->GetFunction());
    constructor = Persistent<Function>::New(tpl->GetFunction());
}

/**
 * 真正初始化的方法
 */
Handle<Value> Check::New(const Arguments& args)
{
    HandleScope scope;
    if(args.IsConstructCall()){ //from new GradeLevel()
        Check * obj = new Check();
        obj->Wrap(args.This());
        return args.This();
    }
    else{   //from GradeLevel()
        const int argc = 0;
        Local<Value> argv[argc] = {};
        return scope.Close(constructor->NewInstance(argc, argv));
    }
}

/**
 * 设置红球开奖号码
 */
Handle<Value> Check::SetRedBall(const Arguments& args)
{
    HandleScope scope;
    //校验参数的类型
    if (!args[0]->IsArray()) {
        ThrowException(Exception::TypeError(String::New("Wrong arguments")));
        return scope.Close(Undefined());
    }
    Check *obj = ObjectWrap::Unwrap<Check>(args.This());
    Local<Array> pArray = Local<Array>::Cast(args[0]);
    int length = pArray->Length();
    if(length != obj->redBallLength)
    {
        ThrowException(Exception::Error(String::New("arguments length illegle")));
        return scope.Close(Undefined());
    }
    int index = 0;
    for(; index < obj->redBallLength; index++)
    {
        obj->redBall[index] = pArray->Get(index)->ToInt32()->Value();
    }
    return scope.Close(Undefined());
}

/**
 * 设置蓝球开奖号码
 */
Handle<Value> Check::SetBlueBall(const Arguments& args)
{
    HandleScope scope;
    int blueBall = args[0]->ToInt32()->Value();
    Check *obj = ObjectWrap::Unwrap<Check>(args.This());
    obj->blueBall = blueBall;
    return scope.Close(Undefined());
}

/**
 * 设置奖级信息
 */
Handle<Value> Check::SetGl(const Arguments& args)
{
    HandleScope scope;
    Check *obj = ObjectWrap::Unwrap<Check>(args.This());
    GradeLevel *gl = ObjectWrap::Unwrap<GradeLevel>(args[0]->ToObject());
    obj->gl = gl;
    return scope.Close(Undefined());
}

Handle<Value> Check::ToIntArray(const)

/**
 * 算奖
 */
Handle<Value> Check::Count(const Arguments& args)
{
    HandleScope scope;
    Handle<Array> array = Array::New();
    Handle<Object> obj = Object::New();
    obj->Set(String::NewSymbol("bonus"), Number::New(4000));
    obj->Set(String::NewSymbol("bonusBeforeTax"), Number::New(4000));
    obj->Set(String::NewSymbol("level"), Number::New(1));
    obj->Set(String::NewSymbol("count"), Number::New(1));
    array->Set(0, obj);
    return scope.Close(array);
}

/**
 * 单式算计
 */
Handle<Value> Check::Count0000(const Arguments& args)
{
    HandleScope scope;
    Handle<Array> array = Array::New();
    Handle<Object> obj = Object::New();
    obj->Set(String::NewSymbol("bonus"), Number::New(4000));
    obj->Set(String::NewSymbol("bonusBeforeTax"), Number::New(4000));
    obj->Set(String::NewSymbol("level"), Number::New(1));
    obj->Set(String::NewSymbol("count"), Number::New(1));
    array->Set(0, obj);
    return scope.Close(array);
}


/**
 * Init方法中已经初始化过constructor变量，所以在这儿可以使用
 * constructor来新建一个对象。
 */
Handle<Value> Check::NewInstance(const Arguments& args)
{
    HandleScope scope;
    const unsigned argc = 0;
    Handle<Value> argv[argc] = {};
    Local<Object> instance = constructor->NewInstance(argc, argv);
    return scope.Close(instance);
}